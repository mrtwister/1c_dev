---
layout: post
title: "Основные моменты при работе с СКД"
date: 2012-09-05 21:09
categories: "skd"
description: "В данном топике я хотел бы затронуть, некоторые моменты работы с СКД: работа с формой отчета, использование нескольких схем компоновки данных, работа с параметрами и так по мелочи, что накопилось за время использования СКД."
---

##Как использовать параметры в СКД?
При написании отчета для СКД иногда возникает потребность в использовании параметров, какие есть варианты? Для начала надо определиться что для того что бы параметры стали доступными, необходимо поставить галочку в схеме вот здесь:
![Доступность параметра](http://i.imgur.com/zJHEInG.png)

1. Тыкнуть по кнопочке настройки, и задать настройки на стандартной форме. Мы этот вариант даже рассматривать не будем, по той простой причине, что их видно на стандартной форме невооруженным глазом, достаточно тыкнуть на кнопку... Настройки конечно же.
2. Сделать таблицу на форме и указать у нее источник.
3. Добавить на форму отчета поля ввода и прописать изменение параметров СКД при их изменении

Рассмотрим  все варианты по подробнее.
###2. Вывод всех прописанных настроек в одной таблице
Это делается очень просто, добавляется таблица значений на форму а источником данных нужно указать: ОтчетОбъект -> КомпоновщикНастроек -> Настройки -> Параметры данных.
###3. Вынесение параметров отчета на форму, как правило самый нужный и удобный метод установки параметров.
Для этого создадим форму отчета, если вы ее еще не создали (куда то, нам надо вынести параметры которые мы будем передавать в СКД) и добавим поле ввода нужного нам типа. И в событии "ПриИзменении" укажем следующий код:
<pre><p>Параметры <font color=red>= </font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>.</font>ПараметрыДанных<font color=red>;<br>
</font>Параметр <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font><font color=black>"ПараметрУказанныйВЗапросе"</font><font color=red>));<br>
Если </font>Параметр <font color=red><> Неопределено Тогда<br>
&nbsp; &nbsp; </font>Параметр<font color=red>.</font>Значение <font color=red>= </font>ЗначениеКотороеМыХотимУстановить<font color=red>;<br>
&nbsp; &nbsp; </font>Параметр<font color=red>.</font>Использование <font color=red>= Истина;<br>
КонецЕсли;</font></p></pre>
Готово! Теперь при изменении элемента на форме параметр будет автоматически загружаться в СКД.
##Использование нескольких схем
Периодически бывает что один отчет должен показывать вроде бы одну и ту же информацию но в разрезе разных показателей. И вроде отчет тот же, только сменился тип аналитики, или убрали колонку, которая участвовала в расчетах, но "почти" это для пользователя, для разработчика это уже другой набор полей и уже скорее всего структура другая, вообщем необходимо делать другой отчет, но можно просто использовать несколько схем и переключаться между ними по мере надобности. Переключаться между схемами несложно, достаточно сделать кнопочку повешать на нее следующую процедуру:
<pre><p><font color=red>Процедура </font>СменитьСхему<font color=red>()<br>
&nbsp; &nbsp; </font>СхемаКомпоновкиДанных <font color=red>= </font>ПолучитьМакет<font color=red>(</font><font color=black>"ЗдесьНадоУказатьИмяСхемы"</font><font color=red>);<br>
&nbsp; &nbsp; </font>Настройки <font color=red>= </font>СхемаКомпоновкиДанных<font color=red>.</font>НастройкиПоУмолчанию<font color=red>;<br>
&nbsp; &nbsp; </font>КомпоновщикНастроек<font color=red>.</font>ЗагрузитьНастройки<font color=red>(</font>Настройки<font color=red>);<br>
КонецПроцедуры</font></p></pre>
Как видите, все просто, при желании можно сократить до двух строк или даже одной, но не уверен, что это пойдет на пользу читаемости кода. Но тут есть свой нюанс, при загрузке новых настроек старые параметры сотрутся, что на самом деле логично, но нас такое положение дел совершенно не устраивает. Какой из этого есть выход? Я думаю надо перед сменой компоновки параметры, надо сохранить в какой то буфер, а потом их восстановить. Как получить\записать параметр я уже говорил выше и не буду на это останавливаться. Так как параметров как правило больше чем два, особенно если это сложный отчет, то неправильно будет, писать
<pre><p>Параметр1 <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font><font color=black>"ПараметрИзЗапроса"</font><font color=red>));<br>
</font>СохраненноеЗначение1 <font color=red>= </font>Параметр1<font color=red>.</font>Значение<font color=red>;<br>
<br>
</font>Параметр2 <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font><font color=black>"ПараметрИзЗапроса2"</font><font color=red>));<br>
</font>СохраненноеЗначение2 <font color=red>= </font>Параметр2<font color=red>.</font>Значение<font color=red>;<br>
<br>
</font><font color=green>//смена схемы компоновки<br>
<br>
</font>Параметр1 <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font><font color=black>"ПараметрИзЗапроса"</font><font color=red>));<br>
</font>Параметр1<font color=red>.</font>Значение <font color=red>= </font>СохраненноеЗначение1<font color=red>;<br>
</font>Параметр1<font color=red>.</font>Использование <font color=red>= Истина;<br>
<br>
</font>Параметр2 <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font><font color=black>"ПараметрИзЗапроса2"</font><font color=red>));<br>
</font>Параметр2<font color=red>.</font>Значение <font color=red>= </font>СохраненноеЗначение2<font color=red>;<br>
</font>Параметр2<font color=red>.</font>Использование <font color=red>= Истина;<br>
</font><font color=green>//и тд</font></p></pre>
*Я надеюсь, что вы понимаете, что этот код написан для примера и не стоит использовать перемнные с именами "СохраненноеЗначение1","СохраненноеЗначение2", но даже если не понимаете, все равно не используйте.*
Хочется оптимизировать вышеприведенный код, что бы просто указать: `СохраниСписокПараметров("ЗдесьСписокПараметров");` потом сменить схему и сделать `ВосстановиСписокПараметров("ЗдесьСписокПараметров");` Написанием этих процедур мы и займемся, для этого далее я напишу эти две процедуры, одна будет сохранять параметры в спецально для этого отведнную структуру, другая будет из нее восстанавливать параметры. Вот они обе:
<pre><p><font color=red>Функция </font>СохранитьПараметры<font color=red>(</font>ИменаПараметров<font color=red>)<br>
&nbsp; &nbsp; </font>Параметры <font color=red>= </font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>.</font>ПараметрыДанных<font color=red>;<br>
&nbsp; &nbsp; </font>МассивСИменами <font color=red>= </font>ОбщегоНазначения<font color=red>.</font>РазложитьСтрокуВМассивПодстрок<font color=red>(</font>ИменаПараметров<font color=red>,</font><font color=black>","</font><font color=red>);<br>
&nbsp; &nbsp; </font>СтруктураДляПараметров <font color=red>= Новый </font>Структура<font color=red>;<br>
&nbsp; &nbsp; Для Каждого </font>ИмяПараметра <font color=red>Из </font>МассивСИменами <font color=red>Цикл<br>
&nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font>ИмяПараметра<font color=red>));<br>
&nbsp; &nbsp; &nbsp; &nbsp; Если </font>Параметр <font color=red><> Неопределено Тогда<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>СтруктураДляПараметров<font color=red>.</font>Вставить<font color=red>(</font>ИмяПараметра<font color=red>, </font>Параметр<font color=red>.</font>Значение<font color=red>);<br>
&nbsp; &nbsp; &nbsp; &nbsp; КонецЕсли;<br>
&nbsp; &nbsp; КонецЦикла;<br>
<br>
&nbsp; &nbsp; Возврат </font>СтруктураДляПараметров<font color=red>;<br>
КонецФункции<br>
<br>
Процедура </font>ЗагрузитьПараметры<font color=red>(</font>СтруктураСПараметрами<font color=red>)<br>
&nbsp; &nbsp; </font>Параметры <font color=red>= </font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>.</font>ПараметрыДанных<font color=red>;<br>
&nbsp; &nbsp; Для Каждого </font>ТекущийПараметр <font color=red>Из </font>СтруктураСПараметрами <font color=red>Цикл<br>
&nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font>ТекущийПараметр<font color=red>.</font>Ключ<font color=red>));<br>
&nbsp; &nbsp; &nbsp; &nbsp; Если </font>Параметр <font color=red><> Неопределено Тогда<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр<font color=red>.</font>Значение <font color=red>= </font>ТекущийПараметр<font color=red>.</font>Значение<font color=red>;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр<font color=red>.</font>Использование <font color=red>= Истина;<br>
&nbsp; &nbsp; &nbsp; &nbsp; КонецЕсли;<br>
&nbsp; &nbsp; КонецЦикла;<br>
КонецПроцедуры<br></font></p></pre>
Остановлюсь, что бы более подробно объяснить, что происходит. Функция СохранитьПараметры принимает на входе строку с именами тех параметров которые надо сохранить. Затем она находит по имени нужный параметр и сохраняет в структуру, которую возвращает по окончании перебора всех параметров полученых из строки. То же самое, только наоборот делает процедура загрузить, она принимает структуру и загружает из нее в СКД параметры. Далее надо собрать все вместе, выглядеть это будет примерно так:
<pre><p>
<font color=red>Функция </font>СохранитьПараметры<font color=red>(</font>ИменаПараметров<font color=red>)<br>
&nbsp; &nbsp; </font>Параметры <font color=red>= </font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>.</font>ПараметрыДанных<font color=red>;<br>
&nbsp; &nbsp; </font>МассивСИменами <font color=red>= </font>ОбщегоНазначения<font color=red>.</font>РазложитьСтрокуВМассивПодстрок<font color=red>(</font>ИменаПараметров<font color=red>,</font><font color=black>","</font><font color=red>);<br>
&nbsp; &nbsp; </font>СтруктураДляПараметров <font color=red>= Новый </font>Структура<font color=red>;<br>
&nbsp; &nbsp; Для Каждого </font>ИмяПараметра <font color=red>Из </font>МассивСИменами <font color=red>Цикл<br>
&nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font>ИмяПараметра<font color=red>));<br>
&nbsp; &nbsp; &nbsp; &nbsp; Если </font>Параметр <font color=red><> Неопределено Тогда<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>СтруктураДляПараметров<font color=red>.</font>Вставить<font color=red>(</font>ИмяПараметра<font color=red>, </font>Параметр<font color=red>.</font>Значение<font color=red>);<br>
&nbsp; &nbsp; &nbsp; &nbsp; КонецЕсли;<br>
&nbsp; &nbsp; КонецЦикла;<br>
<br>
Возврат </font>СтруктураДляПараметров<font color=red>;<br>
КонецФункции<br>
<br>
<br>
Процедура </font>ЗагрузитьПараметры<font color=red>(</font>СтруктураСПараметрами<font color=red>)<br>
&nbsp; &nbsp; </font>Параметры <font color=red>= </font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>.</font>ПараметрыДанных<font color=red>;<br>
&nbsp; &nbsp; Для Каждого </font>ТекущийПараметр <font color=red>Из </font>СтруктураСПараметрами <font color=red>Цикл<br>
&nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр <font color=red>= </font>Параметры<font color=red>.</font>НайтиЗначениеПараметра<font color=red>(Новый </font>ПараметрКомпоновкиДанных<font color=red>(</font>ТекущийПараметр<font color=red>.</font>Ключ<font color=red>));<br>
&nbsp; &nbsp; &nbsp; &nbsp; Если </font>Параметр <font color=red><> Неопределено Тогда<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр<font color=red>.</font>Значение <font color=red>= </font>ТекущийПараметр<font color=red>.</font>Значение<font color=red>;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>Параметр<font color=red>.</font>Использование <font color=red>= Истина;<br>
&nbsp; &nbsp; &nbsp; &nbsp; КонецЕсли;<br>
&nbsp; &nbsp; КонецЦикла;<br>
КонецПроцедуры<br>
<br>
<br>
Процедура </font>СменитьСхему<font color=red>()<br>
&nbsp; &nbsp; </font>СтруктураСНастройками <font color=red>= </font>СохранитьПараметры<font color=red>(</font><font color=black>"Параметр1,Параметр2,Параметр3"</font><font color=red>);<br>
&nbsp; &nbsp; </font>СхемаКомпоновкиДанных <font color=red>= </font>ПолучитьМакет<font color=red>(</font><font color=black>"ЗдесьИмяНужнойВамСхемы"</font><font color=red>);<br>
&nbsp; &nbsp; </font>Настройки <font color=red>= </font>СхемаКомпоновкиДанных<font color=red>.</font>НастройкиПоУмолчанию<font color=red>;<br>
&nbsp; &nbsp; </font>КомпоновщикНастроек<font color=red>.</font>ЗагрузитьНастройки<font color=red>(</font>Настройки<font color=red>);<br>
&nbsp; &nbsp; </font>ЗагрузитьПараметры<font color=red>(</font>СтруктураСНастройками<font color=red>);<br>
КонецПроцедуры</font></p></pre>
##Вывод СКД в отчет
Если вы создали форму отчета у СКД(то есть если у вас отчет и есть схема компоновки данных), то по умолчанию на кнопке "Сформировать" висит предустанновленная команда "Сфрмировать", которая запустит текущую схему, но можно туда повесить свой обработчик, если нужно перед формированием сделать какие нибудь манипуляции, вот код который можно туда повесить:
<pre><p>КомпоновщикМакета<font color=red>=Новый </font>КомпоновщикМакетаКомпоновкиДанных<font color=red>;<br>
</font>МакетКомпоновкиДанных<font color=red>=</font>КомпоновщикМакета<font color=red>.</font>Выполнить<font color=red>(</font>СхемаКомпоновкиДанных<font color=red>,</font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>,</font>ДанныеРасшифровки<font color=red>);<br>
</font>ПроцессорКомпоновкиДанных<font color=red>=Новый </font>ПроцессорКомпоновкиДанных<font color=red>;<br>
</font>ПроцессорКомпоновкиДанных<font color=red>.</font>Инициализировать<font color=red>(</font>МакетКомпоновкиДанных<font color=red>,,</font>ДанныеРасшифровки<font color=red>,Истина);<br>
</font>ПроцессорВывода<font color=red>=Новый </font>ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент<font color=red>;<br>
</font>ПроцессорВывода<font color=red>.</font>УстановитьДокумент<font color=red>(</font>ЭлементыФормы<font color=red>.</font>Результат<font color=red>);<br>
</font>ПроцессорВывода<font color=red>.</font>Вывести<font color=red>(</font>ПроцессорКомпоновкиДанных<font color=red>);</font></p></pre>
Если вы не понимаете, что вообще происходит, просто сделайте кнопку на форме, и засуньте в обработчик этот код, сразу станет понятно, что все просто и что в целом то даже процессом вывода можно управлять, например перед формированием отчета, можно установить заголовок, в зависимости от установленных параметров или свернуть группировки после формирования, или время там формирования засечь, всякое бывает. Также можно вывести разом, а можно построчно, посмотреть детали можно в синтаксис помощнике по адресу Общие объекты -> Система компоновки данных -> Работа с механизмом -> ПроцессорВыводаРезультатаКомпоновкиДанных
###Установка в качестве параметра списка значений.
Когда нужно использовать список значений, для параметра необходимо установить галочку "Доступен список значений" иначе, даже если на входе будет список, СКД все равно будет брать только первое значение, галочка вот здесь:
![Параметр в списке](http://i.imgur.com/1ENucxo.png)
С этой галочкой в штатном списке параметров СКД, вы бонусом получаете красивый и удобный список для подбора ваших значений.

###Вывод СКД в таблицу.
Бывает нужен, если нужно проанализировать или что то сделать с результатами работы, что бы получить результат работы  СКД в таблицу значений или в дерево значений, вам поможет следующий код:
<pre><p>КомпоновщикМакета<font color=red>=Новый </font>КомпоновщикМакетаКомпоновкиДанных<font color=red>;<br>
</font>МакетКомпоновкиДанных<font color=red>=</font>КомпоновщикМакета<font color=red>.</font>Выполнить<font color=red>(</font>СхемаКомпоновкиДанных<font color=red>,</font>КомпоновщикНастроек<font color=red>.</font>Настройки<font color=red>,,,</font>Тип<font color=red>(</font><font color=black>"ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"</font><font color=red>));<br>
</font>ПроцессорКомпоновкиДанных<font color=red>=Новый </font>ПроцессорКомпоновкиДанных<font color=red>;<br>
</font>ПроцессорКомпоновкиДанных<font color=red>.</font>Инициализировать<font color=red>(</font>МакетКомпоновкиДанных<font color=red>);<br>
<br>
</font>ТЗДляВывода <font color=red>= Новый </font>ТаблицаЗначений<font color=red>;</font><font color=green>//здесь может быть и дерево значений<br>
</font>ПроцессорВывода <font color=red>= Новый </font>ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений<font color=red>;<br>
</font>ПроцессорВывода<font color=red>.</font>УстановитьОбъект<font color=red>(</font>ТЗДляВывода<font color=red>);<br>
</font>ПроцессорВывода<font color=red>.</font>Вывести<font color=red>(</font>ПроцессорКомпоновкиДанных<font color=red>);</font></p>
</pre>
собственно здесь в ТЗДляВывода мы получаем результат формирования отчета. Собственно если не касаться непосредствнно самого СКД, то здесь описаны практически все моменты работы с формой отчета построенного на СКД.
###Бонусы
Тому кто домучал до конца эту длинную повесть, пригодятся бонусы:
Курс от гилева про СКД, что бы не искать информацию про СКД, можно скачать [бесплатный курс по СКД](http://www.spec8.ru/kurs-po-skd-besplatno)
Можно взять [шаблон, в котором есть все нужные для оформления фичи](https://googledrive.com/host/0BxFnXEinPWUJckpLWkVCVjc0dUU/%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD.erf)
