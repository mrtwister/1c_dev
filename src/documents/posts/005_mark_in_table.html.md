---
layout: post
title: "Печать этикеток из поступления только отмеченной номенклатуры"
date: 2012-09-23 20:53
categories: "develop1c"
description: "Попросил как то меня клиент, а можно мне галочку в табличную часть документа поступления, что бы можно было печатать этикетки только у определенной номенклатуры, а не для всех 2000 позиций которые пришли с этим поступлением? Да не вопрос, 5 минут и готово! Ответил я и закатав рукава, приступил к работе, оказалось что я не учел несколько деталей..."
---
###В чем соль?
Реквизит в табличную часть документа добавлять нельзя, так как установка флажка изменяет табличную часть, то форма получает признак модифицированности и постоянные вопросы о необходимости сохранять документ, немного нервируют пользователя(а если документ большой и проведенный, то процедура сохранения, еще и какое то время занимает) в целом это можно было бы и пережить(можно и признак модифицированности скидывать), но клиент мириться с этим не захотел, а так как если при печати все равно придется анализировать табличное поле, было решено сделать колонку не связанную с данными табличной части. В результате анализа ситуации стало ясно следующее:

1. Если данные не хранятся в табличной части, то придется самому позаботится о том где мы будеи держать информацию об отмеченных строках.

2. Механизм отрисовки флажка тоже придется взять на себя.

Как обычно прежде чем начинать городить велосипед, был сделан запрос к [базе знаний](http://www.forum.mista.ru "миста") и выяснено следующее: для моего случая уже есть описанный случай на ИТС и называется он `Реализация отметки строк флажками в табличном поле`. Раз есть готовый код, то берем его, модифицируем, используем. Итак поехали:
###Реализация отметок в табличном поле
Для начала, надо добавить колонку в табличное поле и нужно указать, что элемент управления - флажок, ну и название придумать какое нибудь. Теперь надо позаботится об объекте где будут храниться данные об наших отметках. Это будет переменная и называться она будет `СписокОтметок`, так и объявим в начале модуля:
`Перем СписокОтметок;`
в конце где выполняется код при открытии модуля (если не понимаете о чем я просто поставьте самой последней строкой) укажем тип нашей переменной: `СписокОтметок = Новый Соответствие.`

Теперь надо организовать изменение этого списка, когда пользователь щелкает по флажку в табличной части, для этого подойдет событие табличного поля `ПриИзмененииФлажка`, в нем нам надо указать следующее:

<pre><p><font color=red>Процедура </font>ТоварыПриИзмененииФлажка<font color=red>(</font>Элемент<font color=red>, </font>Колонка<font color=red>)<br>
&nbsp; &nbsp; Если </font>Колонка<font color=red>.</font>Имя <font color=red>= </font><font color=black>"Отметка" </font><font color=red>Тогда<br>
&nbsp; &nbsp; &nbsp; &nbsp; Если </font>СписокОтметок<font color=red>[</font>Элемент<font color=red>.</font>ТекущаяСтрока<font color=red>] = Неопределено Тогда<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>СписокОтметок<font color=red>[</font>Элемент<font color=red>.</font>ТекущаяСтрока<font color=red>] = Истина;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Иначе<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </font>СписокОтметок<font color=red>.</font>Удалить<font color=red>(</font>Элемент<font color=red>.</font>ТекущаяСтрока<font color=red>);<br>
&nbsp; &nbsp; &nbsp; &nbsp; КонецЕсли;<br>
&nbsp; &nbsp; КонецЕсли;<br>
КонецПроцедуры</font></p></pre>

Что здесь происходит: когда пользователь щелкает по флажку, процедура ищет нужную строку табличной части и если ее нет, то добавляет, если есть удалет, таким образом, осуществляя изменение состояния флажка.

Теперь нужно организовать вывод флажков в табличное поле, на текущий момент юзер не видит установленных флажков в табличном поле. Для работы с выводом, нужно использовать событие `ПриВыводеСтроки` вот такой код используется для вывода флажка:

<pre><p>ОформлениеСтроки<font color=red>.</font>Ячейки<font color=red>.</font>Отметка<font color=red>.</font>ОтображатьФлажок <font color=red>= Истина;<br>
Если </font>СписокОтметок<font color=red>[</font>ДанныеСтроки<font color=red>] = Неопределено Тогда<br>
&nbsp; &nbsp; </font>ОформлениеСтроки<font color=red>.</font>Ячейки<font color=red>.</font>Отметка<font color=red>.</font>Флажок <font color=red>= Ложь;<br>
Иначе<br>
&nbsp; &nbsp; </font>ОформлениеСтроки<font color=red>.</font>Ячейки<font color=red>.</font>Отметка<font color=red>.</font>Флажок <font color=red>= Истина;<br>
КонецЕсли;</font></p></pre>

Тут все тоже очень просто: если текущая строка есть в списке отметок мы ее отметим если нету, не будем. Таким образом у нас есть список тех строк табличной части документов, которые были отмечены.
###Передача отмеченных строк в обработку печати этикеток.
Для того, что бы передать список номенклатуры, в обработку печати этикеток, я нашел два варианта, это передать ссылку на группу или ссылку на номенклатуру. Или что бы со списком было бы еще количество, можно передать ссылку на документ. Нам не подходит не первое, не второе. Так как нам нужно и количество и определенный список. Поэтому я немного переделал процедуру печати этикеток `НапечататьЭтикеткиИзДокумента`, которая формирует из ссылки на табличную часть документа, таблицу товары, которую принимает обработка печати этикеток. Для начала я выгрузил в таблицу значений отмеченные значения, загрузил ее во временную таблицу в запросе.
<pre><p>МВТ <font color=red>= Новый </font>МенеджерВременныхТаблиц<font color=red>;<br>
</font>ТаблицаИзДока <font color=red>= Новый </font>Запрос<font color=red>;<br>
</font>ТаблицаИзДока<font color=red>.</font>МенеджерВременныхТаблиц <font color=red>= </font>МВТ<font color=red>;<br>
</font>ТаблицаИзДока<font color=red>.</font>Текст <font color=red>=<br>
&nbsp; &nbsp; </font><font color=black>"Выбрать<br>
&nbsp; &nbsp; |Таблица.Номенклатура,<br>
&nbsp; &nbsp; |Таблица.Количество,<br>
&nbsp; &nbsp; |Таблица.ЕдиницаИзмерения,<br>
&nbsp; &nbsp; |ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,<br>
&nbsp; &nbsp; |ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,<br>
&nbsp; &nbsp; |ЗНАЧЕНИЕ(Справочник.Качество.Новый) КАК Качество,<br>
&nbsp; &nbsp; |0 КАК Цена<br>
&nbsp; &nbsp; |ПОМЕСТИТЬ ТаблицаИЗДока<br>
&nbsp; &nbsp; |ИЗ<br>
&nbsp; &nbsp; |&ТаблицаСДанными КАК Таблица"</font><font color=red>;<br>
</font>ТаблицаИзДока<font color=red>.</font>УстановитьПараметр<font color=red>(</font><font color=black>"ТаблицаСДанными"</font><font color=red>, </font>ТабличкаИЗДокумента<font color=red>);<br>
</font>ТаблицаИзДока<font color=red>.</font>Выполнить<font color=red>();</font></p></pre>

Полученную временную таблицу я передал в запрос, выбирающий данные из регистра штрихкодов:
<pre><p>Запрос <font color=red>= Новый </font>Запрос<font color=red>;<br>
</font>Запрос<font color=red>.</font>МенеджерВременныхТаблиц <font color=red>= </font>МВТ<font color=red>;<br>
</font>Запрос<font color=red>.</font>Текст <font color=red>=<br>
&nbsp; &nbsp; </font><font color=black>"ВЫБРАТЬ<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.Номенклатура КАК Номенклатура,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.Количество КАК Количество,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.Характеристика КАК Характеристика,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.Серия КАК Серия,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.Качество КАК Качество,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.ЕдиницаИзмерения КАК ЕдиницаИзмерения,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; Док.Цена КАК Цена,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; РегШК.ТипШтрихкода КАК ТипШтрихкода,<br>
&nbsp; &nbsp; |&nbsp;&nbsp; РегШК.Штрихкод КАК Штрихкод<br>
&nbsp; &nbsp; |ИЗ<br>
&nbsp; &nbsp; |&nbsp;&nbsp; ТаблицаИЗДока КАК Док<br>
&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp;&nbsp; ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.Штрихкоды КАК РегШК<br>
&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp;&nbsp; ПО (РегШК.Владелец = Док.Номенклатура)<br>
&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; И (РегШК.ЕдиницаИзмерения = Док.ЕдиницаИзмерения)<br>
&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; И (РегШК.ХарактеристикаНоменклатуры = Док.Характеристика)<br>
&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; И (РегШК.СерияНоменклатуры = Док.Серия)<br>
&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; И (РегШК.Качество = Док.Качество)"</font><font color=red>;</font></p></pre>
после этого остается только напечатать этикетки
<pre><p>ЗаполнениеДокументов<font color=red>.</font>ПечатьЭтикеток<font color=red>(</font>Запрос<font color=red>.</font>Выполнить<font color=red>().</font>Выгрузить<font color=red>());</font></p></pre>
