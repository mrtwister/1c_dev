<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[1C-developer]]></title>
  <link href="http://mrtwister.github.com/1c_dev/atom.xml" rel="self"/>
  <link href="http://mrtwister.github.com/1c_dev/"/>
  <updated>2012-09-06T02:00:37+11:00</updated>
  <id>http://mrtwister.github.com/1c_dev/</id>
  <author>
    <name><![CDATA[Роман Беляев]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Основные моменты при работе с СКД]]></title>
    <link href="http://mrtwister.github.com/1c_dev/blog/2012/09/05/osnovnyie-momienty-pri-rabotie-s-skd/"/>
    <updated>2012-09-05T21:09:00+11:00</updated>
    <id>http://mrtwister.github.com/1c_dev/blog/2012/09/05/osnovnyie-momienty-pri-rabotie-s-skd</id>
    <content type="html"><![CDATA[<p>В данном топике я хотел бы затронуть, некоторые моменты работы с СКД: работа с формой отчета, использование нескольких схем компоновки данных, работа с параметрами и так по мелочи, что накопилось за время использования СКД. Итак:<!-- more --></p>

<h2>Как использовать параметры в СКД?</h2>

<p>При написании отчета для СКД иногда возникает потребность в использовании параметров, какие есть варианты? Для начала надо определиться что для того что бы параметры стали доступными, необходимо поставить галочку в схеме вот здесь:
<img src="http://i.minus.com/ierRVE7WtSai1.png"></p>

<ol>
<li>Тыкнуть по кнопочке настройки, и задать настройки на стандартной форме. Мы этот вариант даже рассматривать не будем, по той простой причине, что их видно на стандартной форме невооруженным глазом, достаточно тыкнуть на кнопку&#8230; Настройки конечно же.</li>
<li>Сделать таблицу на форме и указать у нее источник.</li>
<li>Добавить на форму отчета поля ввода и прописать изменение параметров СКД при их изменении</li>
</ol>


<p>Рассмотрим  все варианты по подробнее.</p>

<h3>2. Вывод всех прописанных настроек в одной таблице</h3>

<p>Это делается очень просто, добавляется таблица значений на форму а источником данных нужно указать: ОтчетОбъект -> КомпоновщикНастроек -> Настройки -> Параметры данных.</p>

<h3>3. Вынесение параметров отчета на форму, как правило самый нужный и удобный метод установки параметров.</h3>

<p>Для этого создадим форму отчета, если вы ее еще не создали (куда то, нам надо вынести параметры которые мы будем передавать в СКД) и добавим поле ввода нужного нам типа. И в событии &#8220;ПриИзменении&#8221; укажем следующий код:</p>

<figure class='code'><figcaption><span>ПриИзменении </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Параметры = КомпоновщикНастроек.Настройки.ПараметрыДанных;
</span><span class='line'>Параметр = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПараметрУказанныйВЗапросе"));
</span><span class='line'>Если Параметр &lt;> Неопределено Тогда
</span><span class='line'>  Параметр.Значение = ЗначениеКотороеМыХотимУстановить;
</span><span class='line'>  Параметр.Использование = Истина;
</span><span class='line'>КонецЕсли;</span></code></pre></td></tr></table></div></figure>


<p>Готово! Теперь при изменении элемента на форме параметр будет автоматически загружаться в СКД.</p>

<h2>Использование нескольких схем</h2>

<p>Периодически бывает что один отчет должен показывать вроде бы одну и ту же информацию но в разрезе разных показателей. И вроде отчет тот же, только сменился тип аналитики, или убрали колонку, которая участвовала в расчетах, но &#8220;почти&#8221; это для пользователя, для разработчика это уже другой набор полей и уже скорее всего структура другая, вообщем необходимо делать другой отчет, но можно просто использовать несколько схем и переключаться между ними по мере надобности. Переключаться между схемами несложно, достаточно сделать кнопочку повешать на нее следующую процедуру:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Процедура СменитьСхему()
</span><span class='line'>  СхемаКомпоновкиДанных = ПолучитьМакет("ЗдесьНадоУказатьИмяСхемы");
</span><span class='line'>  Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
</span><span class='line'>  КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
</span><span class='line'>КонецПроцедуры</span></code></pre></td></tr></table></div></figure>


<p>Как видите, все просто, при желании можно сократить до двух строк или даже одной, но не уверен, что это пойдет на пользу читаемости кода. Но тут есть свой нюанс, при загрузке новых настроек старые параметры сотрутся, что на самом деле логично, но нас такое положение дел совершенно не устраивает. Какой из этого есть выход? Я думаю надо перед сменой компоновки параметры, надо сохранить в какой то буфер, а потом их восстановить. Как получить\записать параметр я уже говорил выше и не буду на это останавливаться. Так как параметров как правило больше чем два, особенно если это сложный отчет, то неправильно будет, писать</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Параметр1 = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПараметрУказанныйВЗапросе"));
</span><span class='line'>СохраненноеЗначение1 = Параметр1.Значение;
</span><span class='line'>
</span><span class='line'>Параметр2 = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПараметрУказанныйВЗапросе2"));
</span><span class='line'>СохраненноеЗначение2 = Параметр2.Значение;
</span><span class='line'>
</span><span class='line'>...//смена схемы компоновки
</span><span class='line'>
</span><span class='line'>Параметр1 = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПараметрУказанныйВЗапросе"));
</span><span class='line'>Параметр1.Значение = СохраненноеЗначение1;
</span><span class='line'>Параметр1.Использование = Истина;
</span><span class='line'>
</span><span class='line'>Параметр2 = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ПараметрУказанныйВЗапросе2"));
</span><span class='line'>Параметр2.Значение = СохраненноеЗначение2;
</span><span class='line'>Параметр2.Использование = Истина;
</span><span class='line'>//и тд</span></code></pre></td></tr></table></div></figure>


<p>Я надеюсь, что вы понимаете, что этот код написан для примера и не стоит использовать перемнные с именами &#8220;СохраненноеЗначение1&#8221;,&#8221;СохраненноеЗначение2&#8221;, но даже если не понимаете, все равно не используйте.
Надо бы указать: СохраниСписокПараметров(&#8220;ЗдесьСписокПараметров&#8221;); потом сменить схему и сделать ВосстановиСписокПараметров(&#8220;ЗдесьСписокПараметров&#8221;); Этим мы и займемся, для этого далее я напишу эти две процедуры, одна будет сохранять параметры в спецально для этого отведнную структуру, другая будет из нее восстанавливать параметры. Вот они:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Функция СохранитьПараметры(ИменаПараметров)
</span><span class='line'>  Параметры = КомпоновщикНастроек.Настройки.ПараметрыДанных;
</span><span class='line'>  МассивСИменами = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок(ИменаПараметров,",");
</span><span class='line'>  СтруктураДляПараметров = Новый Структура;
</span><span class='line'>  Для Каждого ИмяПараметра Из МассивСИменами Цикл
</span><span class='line'>      Параметр = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
</span><span class='line'>      Если Параметр &lt;> Неопределено Тогда
</span><span class='line'>          СтруктураДляПараметров.Вставить(ИмяПараметра, Параметр.Значение);
</span><span class='line'>      КонецЕсли; 
</span><span class='line'>  КонецЦикла;   
</span><span class='line'>  
</span><span class='line'>  Возврат СтруктураДляПараметров;
</span><span class='line'>КонецФункции
</span><span class='line'>
</span><span class='line'>Процедура ЗагрузитьПараметры(СтруктураСПараметрами)
</span><span class='line'>  Параметры = КомпоновщикНастроек.Настройки.ПараметрыДанных;
</span><span class='line'>    Для Каждого ТекущийПараметр Из СтруктураСПараметрами Цикл
</span><span class='line'>      Параметр = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ТекущийПараметр.Ключ));
</span><span class='line'>      Если Параметр &lt;> Неопределено Тогда
</span><span class='line'>          Параметр.Значение = ТекущийПараметр.Значение;
</span><span class='line'>          Параметр.Использование = Истина;
</span><span class='line'>      КонецЕсли; 
</span><span class='line'>  КонецЦикла;   
</span><span class='line'>КонецПроцедуры</span></code></pre></td></tr></table></div></figure>


<p>Остановлюсь, что бы более подробно объяснить, что происходит. Функция СохранитьПараметры принимает на входе строку с именами тех параметров которые надо сохранить. Затем в строке 6 она находит по имени нужный параметр и сохраняет в структуру, которую возвращает по окончании перебора всех параметров полученых из строки. То же самое, только наоборот делает процедура загрузить, она принимает структуру и загружает из нее в СКД параметры. Далее надо собрать все вместе, выглядеть это будет примерно так:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Функция СохранитьПараметры(ИменаПараметров)
</span><span class='line'>  Параметры = КомпоновщикНастроек.Настройки.ПараметрыДанных;
</span><span class='line'>  МассивСИменами = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок(ИменаПараметров,",");
</span><span class='line'>  СтруктураДляПараметров = Новый Структура;
</span><span class='line'>  Для Каждого ИмяПараметра Из МассивСИменами Цикл
</span><span class='line'>      Параметр = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
</span><span class='line'>      Если Параметр &lt;> Неопределено Тогда
</span><span class='line'>          СтруктураДляПараметров.Вставить(ИмяПараметра, Параметр.Значение);
</span><span class='line'>      КонецЕсли; 
</span><span class='line'>  КонецЦикла;   
</span><span class='line'>  
</span><span class='line'>  Возврат СтруктураДляПараметров;
</span><span class='line'>КонецФункции
</span><span class='line'>
</span><span class='line'>Процедура ЗагрузитьПараметры(СтруктураСПараметрами)
</span><span class='line'>  Параметры = КомпоновщикНастроек.Настройки.ПараметрыДанных;
</span><span class='line'>    Для Каждого ТекущийПараметр Из СтруктураСПараметрами Цикл
</span><span class='line'>      Параметр = Параметры.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ТекущийПараметр.Ключ));
</span><span class='line'>      Если Параметр &lt;> Неопределено Тогда
</span><span class='line'>          Параметр.Значение = ТекущийПараметр.Значение;
</span><span class='line'>          Параметр.Использование = Истина;
</span><span class='line'>      КонецЕсли; 
</span><span class='line'>  КонецЦикла;   
</span><span class='line'>КонецПроцедуры
</span><span class='line'> 
</span><span class='line'>Процедура СменитьСхему()
</span><span class='line'>  СтруктураСНастройками = СохранитьПараметры("Параметр1,Параметр2,Параметр3");
</span><span class='line'>  СхемаКомпоновкиДанных = ПолучитьМакет("ЗдесьИмяНужнойВамСхемы");
</span><span class='line'>  Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
</span><span class='line'>  КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
</span><span class='line'>  ЗагрузитьПараметры(СтруктураСНастройками);
</span><span class='line'>КонецПроцедуры</span></code></pre></td></tr></table></div></figure>


<h2>Вывод СКД в отчет</h2>

<p>Если вы создали форму отчета у СКД(то есть если у вас отчет и есть схема компоновки данных), то по умолчанию на кнопке &#8220;Сформировать&#8221; висит предустанновленная команда &#8220;Сфрмировать&#8221;, которая запустит текущую схему, но можно туда повесить свой обработчик, если нужно перед формированием сделать какие нибудь манипуляции, вот код который можно туда повесить:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>КомпоновщикМакета=Новый КомпоновщикМакетаКомпоновкиДанных;
</span><span class='line'>МакетКомпоновкиДанных=КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных,КомпоновщикНастроек.Настройки,ДанныеРасшифровки);
</span><span class='line'>ПроцессорКомпоновкиДанных=Новый ПроцессорКомпоновкиДанных;
</span><span class='line'>ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновкиДанных,,ДанныеРасшифровки,Истина);
</span><span class='line'>ПроцессорВывода=Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
</span><span class='line'>ПроцессорВывода.УстановитьДокумент(ЭлементыФормы.Результат);
</span><span class='line'>ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);</span></code></pre></td></tr></table></div></figure>


<p>например перед формированием отчета, можно установить заголовок, в зависимости от установленных параметров или свернуть группировки после формирования, или время там формирования засечь, всякое бывает. Также можно вывести разом, а можно управлять выводом, посмотреть детали можно в синтаксис помощнике по адресу Общие объекты -> Система компоновки данных -> Работа с механизмом -> ПроцессорВыводаРезультатаКомпоновкиДанных</p>

<h3>Установка в качестве параметра списка значений.</h3>

<p>Когда нужно использовать список значений, для параметра необходимо установить галочку &#8220;Доступен список значений&#8221; иначе, даже если на входе будет список, СКД все равно будет брать только первое значение, галочка вот здесь:
<img src="http://i.minus.com/ibugGqPRbDqrl0.png">
С этой галочкой в штатном списке параметров СКД, вы бонусом получаете красивый и удобный список для подбора ваших значений.</p>

<h3>Вывод СКД в таблицу.</h3>

<p>Бывает нужен, если нужно проанализировать или что то сделать с результатами работы, что бы получить результат работы  СКД в таблицу значений или в дерево значений, вам поможет следующий код:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>КомпоновщикМакета=Новый КомпоновщикМакетаКомпоновкиДанных;
</span><span class='line'>МакетКомпоновкиДанных=КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных,КомпоновщикНастроек.Настройки,,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
</span><span class='line'>ПроцессорКомпоновкиДанных=Новый ПроцессорКомпоновкиДанных;
</span><span class='line'>ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновкиДанных);
</span><span class='line'>  
</span><span class='line'>ТЗДляВывода = Новый ТаблицаЗначений;//здесь может быть и дерево значений
</span><span class='line'>ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
</span><span class='line'>ПроцессорВывода.УстановитьОбъект(ТЗДляВывода);
</span><span class='line'>ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);</span></code></pre></td></tr></table></div></figure>


<p>собственно здесь в ТЗДляВывода мы получаем результат формирования отчета. Собственно если не касаться непосредствнно самого СКД, то здесь описаны практически все моменты работы с формой отчета построенного на СКД.</p>

<h3>Бонусы</h3>

<p>Тому кто домучал до конца эту длинную повесть, пригодятся бонусы:
Курс от гилева про СКД, что бы не искать информацию про СКД, можно скачать <a href="http://www.spec8.ru/kurs-po-skd-besplatno">бесплатный курс по СКД</a>
Можно взять <a href="http://i.minus.com/1346925743/KFYgeBupj_IIWeO5NdHyuQ/dp9PtAJ9c62Sh/%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD.erf">шаблон, в котором есть все нужные для оформления фичи</a></p>
]]></content>
  </entry>
  
</feed>
