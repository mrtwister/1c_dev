
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Двойные штрихкода и история одной обработки - Разработчик 1С</title>
  <meta name="author" content="Роман Беляев">

  
  <meta name="description" content="Преамбула В какой то момент в базе встала проблема двойных штрихкодов. Причем ситация до того как на нее обратили внимание, приобрела &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://developer1c.ru/blog/2013/09/08/dvoinyie-shtrikhkoda/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/1c_dev/atom.xml" rel="alternate" title="Разработчик 1С" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href="/stylesheets/1cod.css" media="screen, projection" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34619019-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Разработчик 1С</a></h1>
  
    <h2>Блог о суровых реалиях тупого и жадного 1сника</h2>
  
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/1c_dev/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:developer1c.ru" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Двойные штрихкода и история одной обработки</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-08T22:03:00-07:00" pubdate data-updated="true">Sep 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Преамбула</h3>

<p>В какой то момент в базе встала проблема двойных штрихкодов. Причем ситация до того как на нее обратили внимание, приобрела катосторофический характер и имела полторы тысячи дублей штрихкодов (когда один штрихкод принадлежит нескольким товарам) и порядка 25ти тысяч дублей товаров (когда у одного товарам есть несколько штрихкодов). Что тому виной? На текущий момент уже сложно сказать. Возможно РИБ, когда одному и тому же товару присваивают штрихкод в разных базах. Возможно свою лепту внесли слияния нескольких баз с одинаковым товаром, но разными штрихкодами. Скорее всего все вместе + какой то еще фактор, который мы пока не можем найти. Слишком много вышло дублей, почти четверть базы. Так или иначе встала задача с этими штрихкодами что то сделать.<!-- more --></p>

<h3>Постановка задачи.</h3>

<p>Необходимо найти задублирововашиеся штрихкода и показить пользователю в удобном виде. Дать возможность что то сделать сразу с этими штрихкодами без необходимости лазить по справочникам и регистрам. Если говорить конкретно, то у пользователя должна быть возможность:</p>

<ol>
<li>Удалить все штрихкода у владельца, кроме выделенного.</li>
<li>Удалить конкретный лишний штрихкод.</li>
<li>Одним махом удалить все лишние дубли, оставив по одному на владельца.</li>
<li>Удалить все штрихкода которые засветились как задублированные.</li>
</ol>


<h3>Приступим к реализации первой части.</h3>

<p>Поиск лишних штрихкодов. Сам поиск достататочно банален: нужно воспользоваться функций КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СюдаУказатьПолеДляГруппировки). В самом простом случае, запрос будет выглядеть вот так:</p>

<p style="text-align: left; font-family: courier new,courier; color: black">
<font color=blue>ВЫБРАТЬ<br>
&nbsp; &nbsp; </font>Штрихкоды.Штрихкод<font color=blue>,<br>
&nbsp; &nbsp; </font><font color=brown>КОЛИЧЕСТВО</font><font color=blue>(РАЗЛИЧНЫЕ </font>Штрихкоды.Владелец<font color=blue>) КАК </font>Владелец<br>
<font color=blue>ИЗ<br>
&nbsp; &nbsp; </font>РегистрСведений.Штрихкоды <font color=blue>КАК </font>Штрихкоды<br>
<br>
<font color=blue>СГРУППИРОВАТЬ ПО<br>
&nbsp; &nbsp; </font>Штрихкоды.Штрихкод</p>


<p>Для того, что бы отфильтровать результаты запроса необходимо его обернуть во вложеный запрос и тогда уже можно накладывать условия на результат его работы. В данном случае, мы сделаем вот так:
<img src="http://26226.selcdn.ru/from_st/1/1.gif" title="Сделать вложенный запрос" alt="Картинка с вкладыванием запроса" />
Вот результат этих действий. Ну вот вроде все нормльно, но как то неудобно, для удобства наверно не помешает сгруппировать результаты по штрихкодам. В результате мы можем получить вот такой запрос. Вот результат его работы в консоли.
<img src="https://api.monosnap.com/image/download?id=5e8qdGdh0ss6sMzCTYOarse6J" title="Результат работы запроса в консоли" alt="Результат работы запроса" />
Этот вариант удобен для первого варианта поиска, сделать запрос для второго варианта по аналогии не должно составить труда. Запросы готовы, но не будет же пользователь смотреть на результат его работы из консоли. Здесь нам и поможет дерево значений. Смысл работы с деревом следующий: дерево содержит колекцию колонок и строк. Коллекция колонок не отличается от коллекции колонок в таблице значений и нас не интересует. Коллекция строк немного инетереснее, каждая строка ее может содержать такую же коллекцию строк, каждая строка которой&#8230; вообщем я думаю мысль понятна, таким образом и организуется иерархия. Используем обход результатов запроса по группировкам, для того что сформировать удобное дерево:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Выборка = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
</span><span class='line'>    ЭтаФорма.Заголовок = “Найдено ” + Выборка.Количество();
</span><span class='line'>    Пока Выборка.Следующий() Цикл
</span><span class='line'>        НоваяСтрокаТП = ТабличноеПоле.Строки.Добавить();
</span><span class='line'>        НоваяСтрокаТП.Номенклатура = Выборка.Штрихкод;
</span><span class='line'>
</span><span class='line'>        ВыборкаШтрихКода = Выборка.Выбрать();
</span><span class='line'>        Пока ВыборкаШтрихКода.Следующий() Цикл
</span><span class='line'>            НоваяСтрокаВладелец = НоваяСтрокаТП.Строки.Добавить();
</span><span class='line'>            НоваяСтрокаВладелец.Номенклатура = ВыборкаШтрихКода.Владелец;
</span><span class='line'>        КонецЦикла;
</span><span class='line'>    КонецЦикла;</span></code></pre></td></tr></table></div></figure>


<p>Как следствие мы можем получить вот такую форму:
<img src="https://api.monosnap.com/image/download?id=wDPn9V8vDlujcauOfMSIonqUr" title="Сгруппированные штрихкода на форме" alt="Форма обработки" /></p>

<h3>Работа с регистром штрихкодов</h3>

<p>Когда есть все нужные данные можно начинать работать с регистром штрихкодов. Так как у нас ищутся не только штрихкода с несколькими владельцами, но и владельцы с несколькими штрихкодами, то состав табличного поля может быть разным, это необходимо учитывать. Приступим к реализации п1 - Удалить все штрихкода кроме выделенного. Для этого подготовим данные для записи в регистр. Выделим значение отобора и штрихкод который нам надо оставить:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>СтруктураВРегистр = Новый Структура(“КлючОтбора, ЗначениеОтбора, ШтрихКод, Владелец”);
</span><span class='line'>
</span><span class='line'>    Если ТипЗнч(СтрокаДерева.Номенклатура) = Тип(“СправочникСсылка.Номенклатура”)
</span><span class='line'>        ИЛИ ТипЗнч(СтрокаДерева.Номенклатура) = Тип(“СправочникСсылка.ИнформационныеКарты”) Тогда
</span><span class='line'>        СтруктураВРегистр.КлючОтбора = “Штрихкод”;
</span><span class='line'>        СтруктураВРегистр.ЗначениеОтбора = СтрокаДерева.Родитель.Номенклатура;
</span><span class='line'>
</span><span class='line'>        СтруктураВРегистр.Штрихкод = СтрокаДерева.Родитель.Номенклатура;
</span><span class='line'>        СтруктураВРегистр.Владелец = СтрокаДерева.Номенклатура;
</span><span class='line'>    Иначе
</span><span class='line'>        СтруктураВРегистр.КлючОтбора = “Владелец”;
</span><span class='line'>        СтруктураВРегистр.ЗначениеОтбора = СтрокаДерева.Родитель.Номенклатура;
</span><span class='line'>
</span><span class='line'>        СтруктураВРегистр.Штрихкод = СтрокаДерева.Номенклатура;
</span><span class='line'>        СтруктураВРегистр.Владелец = СтрокаДерева.Родитель.Номенклатура;
</span><span class='line'>    КонецЕсли;</span></code></pre></td></tr></table></div></figure>


<p>Теперь надо удалить все &#8220;лишние&#8221; штрихкода кроме конкретного, того на который указал пользователь. Я решил этот вопрос просто: я очищаю набор по указанному отбору и добавляю нужный штрихкод. По моему это самый простой и быстрый способ. Вот код:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>НаборЗаписей = РегистрыСведений.Штрихкоды.СоздатьНаборЗаписей();
</span><span class='line'>НаборЗаписей.Отбор[СтруктураСДанными.КлючОтбора].Установить(СтруктураСДанными.ЗначениеОтбора);
</span><span class='line'>НаборЗаписей.Записать();
</span><span class='line'>
</span><span class='line'>НоваяЗаписьНабора = НаборЗаписей.Добавить();
</span><span class='line'>НоваяЗаписьНабора.Владелец = СтруктураСДанными.Владелец;
</span><span class='line'>НоваяЗаписьНабора.ЕдиницаИзмерения = СтруктураСДанными.Владелец.ЕдиницаХраненияОстатков;
</span><span class='line'>НоваяЗаписьНабора.ТипШтрихкода = ПланыВидовХарактеристик.ТипыШтрихкодов.EAN13;
</span><span class='line'>НоваяЗаписьНабора.Штрихкод = СтруктураСДанными.ШтрихКод;
</span><span class='line'>НоваяЗаписьНабора.Качество = Справочники.Качество.Новый;
</span><span class='line'>
</span><span class='line'>НаборЗаписей.Записать();</span></code></pre></td></tr></table></div></figure>


<p>Перебирая строки дерева значений можно реализовать и п.3. Мы же идем дальше и приступаем к п.2. Для этих целей я использовал менеджер записи, в целом тут все просто до безобразия:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Если ТипЗнч(ЭлементыФормы.ТабличноеПоле.ТекущиеДанные.Номенклатура) = Тип(“СправочникСсылка.Номенклатура”)
</span><span class='line'>        ИЛИ ТипЗнч(ЭлементыФормы.ТабличноеПоле.ТекущиеДанные.Номенклатура) = Тип(“СправочникСсылка.ИнформационныеКарты”) Тогда
</span><span class='line'>        Штрихкод = ЭлементыФормы.ТабличноеПоле.ТекущаяСтрока.Родитель.Номенклатура;
</span><span class='line'>        Владелец = ЭлементыФормы.ТабличноеПоле.ТекущиеДанные.Номенклатура;
</span><span class='line'>    Иначе
</span><span class='line'>        Штрихкод = ЭлементыФормы.ТабличноеПоле.ТекущиеДанные.Номенклатура;
</span><span class='line'>        Владелец = ЭлементыФормы.ТабличноеПоле.ТекущаяСтрока.Родитель.Номенклатура;
</span><span class='line'>    КонецЕсли;
</span><span class='line'>
</span><span class='line'>    МенеджерЗаписи = РегистрыСведений.Штрихкоды.СоздатьМенеджерЗаписи();
</span><span class='line'>    МенеджерЗаписи.Штрихкод = Штрихкод;
</span><span class='line'>    МенеджерЗаписи.Владелец = Владелец;
</span><span class='line'>    МенеджерЗаписи.ТипШтрихкода = ПланыВидовХарактеристик.ТипыШтрихкодов.EAN13;
</span><span class='line'>    МенеджерЗаписи.ЕдиницаИзмерения = Владелец.ЕдиницаХраненияОстатков;
</span><span class='line'>    МенеджерЗаписи.Качество = Справочники.Качество.Новый;
</span><span class='line'>    МенеджерЗаписи.Прочитать();
</span><span class='line'>    МенеджерЗаписи.Удалить();</span></code></pre></td></tr></table></div></figure>


<p>Остался последний самый простой пункт. Я думаю тут даже код не нужен. Все и так просто. Делаем отбор в наборе и записываем не читая. Вот такая получилась обработка. Почти весь нужный код для работы обработки в этой статье есть. За бортом осталась косметика, украшательства и тд, то, что каждый настраивает по своему вкусу, но если все таки у вас не вышло собрать обработку, то обработку можно <a href="http://infostart.ru/public/200131/">скачать на инфостарте</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Автор <span class="fn">Роман Беляев</span></span>

      








  


<time datetime="2013-09-08T22:03:00-07:00" pubdate data-updated="true">Sep 8<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/Разработка/'>Разработка</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://developer1c.ru/blog/2013/09/08/dvoinyie-shtrikhkoda/" data-via="belyaev_rs" data-counturl="http://developer1c.ru/blog/2013/09/08/dvoinyie-shtrikhkoda/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/09/23/piechat%27-etikietok-iz-postuplieniia-tol%27ko-otmiechiennoi-nomienklatury/" title="Previous Post: Печать этикеток из поступления только отмеченной номенклатуры">&laquo; Печать этикеток из поступления только отмеченной номенклатуры</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <div id="hypercomments_widget"></div>
  </section>
</div>

<aside class="sidebar">
  
    <section>
  <a href="http://developer1c.ru" title="На главную"><img src="http://developer1c.ru/images/Home.png" alt="На главную"></a>
  <a href="http://developer1c.ru/atom.xml" title="RSS"><img src="http://developer1c.ru/images/rss_big.png" alt="RSS"></a>
  <a href="mailto:belyaev.rs@gmail.com" title="Написать автору"><img src="http://developer1c.ru/images/Envelope.png" alt="Написать автору"></a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/08/dvoinyie-shtrikhkoda/">Двойные штрихкода и история одной обработки</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/23/piechat%27-etikietok-iz-postuplieniia-tol%27ko-otmiechiennoi-nomienklatury/">Печать этикеток из поступления только отмеченной номенклатуры</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/19/lieto-zakonchilos%27-dot-dot-dot/">Лето закончилось...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/18/podkliuchieniie-skaniera-shtrikhkodov-k-1s/">Подключение сканера штрихкодов к 1С</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/07/proghrammnoie-raspolozhieniie-eliemientov-na-formie/">Программное расположение элементов на форме</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("belyaev_rs", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/belyaev_rs" class="twitter-follow-button" data-show-count="false">Follow @belyaev_rs</a>
  
</section>


<section>
  <h1>Об авторе блога</h1>
  <p><img align="left" src="https://twimg0-a.akamaihd.net/profile_images/1407778606/IMG_0017_bigger.JPG">Меня зовут Беляев Роман. Я занимаюсь программированием в 1С и здесь записываю накопленный опыт.</p>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Роман Беляев -
  <span class="credit">Работает на <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<script type="text/javascript">
var _hcp = _hcp || {};_hcp.widget_id = 2839;_hcp.widget = "Stream";
(function() { 
var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://widget.hypercomments.com/apps/js/hc.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hcc, s.nextSibling); 
})();
</script>


</body>
</html>
